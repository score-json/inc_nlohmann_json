name: Coverage Gate

on:
  workflow_call:
    inputs:
      artifact_id:
        description: "Unused, kept for consistency with parent"
        required: true
        type: string

jobs:
  coverage_gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coverage HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: code-coverage-report
          path: coverage_html

      - name: Debug list coverage files
        run: |
          echo "=== coverage_html contents ==="
          ls -R coverage_html

      - name: Enforce coverage threshold
        run: |
          THRESHOLD=99

          echo "=== First few floating numbers in index.html ==="
          grep -oE "[0-9]+\.[0-9]+" coverage_html/index.html | head -n10 || true

          LINE_COV=$(grep -oE "[0-9]+\.[0-9]+" coverage_html/index.html | head -n1 || true)
          echo "Raw extracted coverage: '${LINE_COV}'"

          if [ -z "$LINE_COV" ]; then
            echo "Could not find any numeric coverage value in index.html"
            exit 1
          fi

          echo "Line coverage extracted: ${LINE_COV}% (threshold: ${THRESHOLD}%)"

          if [ "${LINE_COV%.*}" -lt "$THRESHOLD" ]; then
            echo "Coverage below threshold, failing job."
            exit 1
          fi

          echo "Coverage is above threshold."
